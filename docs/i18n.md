# 国际化 (i18n) 系统使用指南

## 概述

本项目实现了完整的中英文国际化支持系统，支持根据客户端请求自动切换语言。

## 功能特性

- ✅ 支持中文 (zh-CN) 和英文 (en-US)
- ✅ 自动从 HTTP 头部 `Accept-Language` 检测语言
- ✅ 支持通过查询参数 `?lang=zh|en` 手动指定语言
- ✅ 统一的响应格式和错误处理
- ✅ 完整的翻译键管理
- ✅ 中间件自动注入翻译函数

## 目录结构

```
├── internal/i18n/          # 国际化核心模块
│   └── i18n.go            # 国际化管理器
├── internal/middlewares/   
│   └── i18n.go            # 国际化中间件
├── internal/response/      
│   └── response.go        # 统一响应处理
├── locales/               # 语言文件目录
│   ├── zh-CN.json         # 中文翻译
│   └── en-US.json         # 英文翻译
└── docs/
    └── i18n.md           # 本文档
```

## 使用方法

### 1. 在控制器中使用

```go
package controllers

import (
    "pnas/internal/response"
    "github.com/gin-gonic/gin"
)

func (c *UserController) CreateUser(ctx *gin.Context) {
    // 验证失败
    if err := validate(req); err != nil {
        response.ValidationError(ctx, err)
        return
    }
    
    // 业务逻辑错误
    if userExists {
        response.BadRequest(ctx, "user.username.exists", nil)
        return
    }
    
    // 成功响应
    response.SuccessWithMessage(ctx, "user.create.success", userData)
}
```

### 2. 响应函数说明

#### 成功响应
```go
// 简单成功响应
response.Success(ctx, data)

// 带自定义消息的成功响应
response.SuccessWithMessage(ctx, "user.create.success", data)

// 分页响应
response.Pagination(ctx, "user.list.success", users, total, page, pageSize)
```

#### 错误响应
```go
// 400 错误
response.BadRequest(ctx, "request.invalid_params", err)

// 401 错误
response.Unauthorized(ctx, "auth.login.invalid_credentials", err)

// 403 错误
response.Forbidden(ctx, "permission.denied", err)

// 404 错误
response.NotFound(ctx, "user.not_found", err)

// 500 错误
response.InternalServerError(ctx, "server.internal_error", err)

// 验证错误
response.ValidationError(ctx, err)
```

### 3. 客户端请求示例

#### 通过 HTTP 头部指定语言
```bash
# 中文请求
curl -H "Accept-Language: zh-CN" http://localhost:8080/api/v1/users

# 英文请求
curl -H "Accept-Language: en-US" http://localhost:8080/api/v1/users
```

#### 通过查询参数指定语言
```bash
# 中文
curl http://localhost:8080/api/v1/users?lang=zh

# 英文
curl http://localhost:8080/api/v1/users?lang=en
```

### 4. 响应格式

#### 成功响应
```json
{
  "code": 200,
  "message": "用户创建成功",
  "data": {
    "id": 1,
    "username": "test"
  }
}
```

#### 错误响应
```json
{
  "code": 400,
  "message": "用户名已存在",
  "error": "duplicate username"
}
```

#### 分页响应
```json
{
  "code": 200,
  "message": "用户列表获取成功",
  "data": [...],
  "meta": {
    "total": 100,
    "per_page": 10,
    "current_page": 1,
    "last_page": 10
  }
}
```

## 翻译键管理

### 命名规范

翻译键采用点分层级结构：

```
模块.操作.状态
```

示例：
- `user.create.success` - 用户创建成功
- `auth.login.failed` - 登录失败
- `validation.required` - 必填字段验证

### 常用翻译键

#### 认证相关
- `auth.login.success` - 登录成功
- `auth.login.invalid_credentials` - 用户名或密码错误
- `auth.logout.success` - 登出成功
- `auth.token.invalid` - 无效的Token

#### 用户管理
- `user.create.success` - 用户创建成功
- `user.update.success` - 用户更新成功
- `user.delete.success` - 用户删除成功
- `user.not_found` - 用户不存在

#### 验证错误
- `validation.required` - 此字段为必填项
- `validation.invalid_format` - 格式不正确
- `request.invalid_params` - 请求参数错误

#### 服务器错误
- `server.internal_error` - 服务器内部错误
- `server.database_error` - 数据库操作失败

## 添加新语言

### 1. 创建语言文件

在 `locales/` 目录下创建新的语言文件，如 `ja-JP.json`：

```json
{
  "success": "成功",
  "user.create.success": "ユーザーが正常に作成されました"
}
```

### 2. 更新代码

在 `internal/i18n/i18n.go` 中添加新的语言常量：

```go
const (
    LocaleZhCN Locale = "zh-CN"
    LocaleEnUS Locale = "en-US"
    LocaleJaJP Locale = "ja-JP" // 新增
)
```

### 3. 更新中间件

在 `internal/middlewares/i18n.go` 中添加语言检测逻辑。

## 测试

运行测试文件验证国际化功能：

```bash
go run test_i18n.go
```

## API 端点

### 获取语言信息

```
GET /api/language
```

响应：
```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "locale": "zh-CN",
    "language": "简体中文",
    "supported": ["zh-CN", "en-US"]
  }
}
```

## 最佳实践

1. **统一使用响应函数**：始终使用 `response` 包中的函数返回响应
2. **合理命名翻译键**：使用清晰的层级结构
3. **完整的翻译覆盖**：确保所有支持的语言都有对应翻译
4. **错误处理**：为不同类型的错误使用不同的翻译键
5. **测试验证**：定期测试各语言的响应是否正确

## 注意事项

- 翻译键不存在时会返回键名本身
- 默认语言为中文 (zh-CN)
- 查询参数 `lang` 的优先级高于 HTTP 头部
- 所有翻译文件必须是有效的 JSON 格式